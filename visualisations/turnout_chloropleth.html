<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Map Chloropleth</title>
    <style>
        body,
        html {
            background-color: #0c1016;
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        #heading {
            flex: 1;
            text-align: center;
            padding: 20px;
        }

        #map-container {
            flex: 3;
            width: 100%;
            overflow: hidden;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(110, 110, 110, 0.7);
            color: rgb(255, 255, 255);
            padding: 5px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
        }

        #year-dropdown {
            padding: 10px;
            font-size: 16px;
            border: 1px solid steelblue;
            border-radius: 5px;
            background-color: #adb9ff;
            color: rgb(0, 0, 0);
            width: 100%;
            box-sizing: border-box;
        }

        .constituency {
            stroke: rgb(0, 0, 0);
            stroke-width: 0.5;
            fill: none;
        }

        .constituency:hover {
            stroke: rgb(4, 255, 0);
            stroke-width: 2;
        }
    </style>

</head>

<body>
    <div id="container">
        <div id="heading">
            <h1 style="color: white;">Voters Turnout % Chloropleth India Yearwise<br>(1962 - 2019)</h1>
            <select id="year-dropdown">
                <option value="1962">1962</option>
                <option value="1967">1967</option>
                <option value="1971">1971</option>
                <option value="1977">1977</option>
                <option value="1980">1980</option>
                <option value="1984">1984</option>
                <option value="1989">1989</option>
                <option value="1991">1991</option>
                <option value="1996">1996</option>
                <option value="1998">1998</option>
                <option value="1999">1999</option>
                <option value="2004">2004</option>
                <option value="2009">2009</option>
                <option value="2014">2014</option>
                <option value="2019">2019</option>
            </select>

        </div>
        <div id="map-container">
            <svg id="india-map" width="1000" height="800"></svg>
        </div>
    </div>

    <div class="tooltip"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        var width = 1000;
        var height = 800;

        var svg = d3.select("#india-map")
            .attr("width", width)
            .attr("height", height);

        var colorScale = d3.scaleSequential(d3.interpolateBlues);

        d3.json("../dataset/india_pc_2012-17.json").then(function (geojson) {

            var projection = d3.geoMercator()
                .fitSize([width, height], geojson);

            var path = d3.geoPath()
                .projection(projection);

            d3.csv("../dataset/modified_data.csv").then(function (data) {

                document.getElementById("year-dropdown").addEventListener("change", function () {
                    var year = this.value;

                    var yearInt = parseInt(year); 

                    var turnoutData = {};
                    data.forEach(function (d) {
                        if (parseInt(d.year) === parseInt(yearInt)) {
                            turnoutData[d.Pc_name.toUpperCase()] = parseInt(d.Turnout);
                        }
                    });
                    console.log(turnoutData);
                    // Update color domain based on the new data
                    var maxTurnout = d3.max(Object.values(turnoutData));
                    colorScale.domain([0, maxTurnout]);

                    // Remove existing paths
                    svg.selectAll(".constituency").remove();

                    // Draw the map
                    // Draw the map
                    // Draw the map
                    svg.selectAll(".constituency")
                        .data(geojson.features)
                        .enter().append("path")
                        .attr("class", "constituency")
                        .attr("d", path)
                        .style("fill", function (d) {
                            var pcName = d.properties.PC_NAME; // Get the PC_NAME property
                            if (pcName) {
                                // Extract the part of the name before the first space or opening parenthesis
                                var pcNameTrimmed = pcName.split(/[\s(]/)[0].toUpperCase();
                                console.log(pcNameTrimmed, turnoutData[pcNameTrimmed] || 0)
                                return colorScale(turnoutData[pcNameTrimmed] || 0);
                            } else {
                                // Handle the case where PC_NAME is undefined
                                return "gray"; // or any other fallback color
                            }
                        })
                        // Event listeners omitted for brevity

                        // Event listeners omitted for brevity

                        // Event listener for mouseover
                        .on("mouseover", function (event, d) {
                            d3.select(this)
                                .style("stroke", "cyan")
                                .style("stroke-width", 3);
                            // Extract constituency properties
                            var pc = d.properties; // Extract properties directly from the data
                            if (pc && pc.PC_NAME) {
                                var pcName = pc.PC_NAME.toUpperCase(); // Extract the constituency name
                                var value = turnoutData[pcName] || "N/A";
                                // Show tooltip
                                tooltip.style("opacity", 1)
                                    .html("Constituency: " + pcName + "<br>" + "Turnout: " + value + "%")
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 28) + "px");
                            }
                        })

                        .on("mouseout", function () {
                            d3.select(this)
                                .style("stroke", "black")
                                .style("stroke-width", 0.5);
                            // Hide tooltip
                            tooltip.style("opacity", 0);
                        });
                });

                // Trigger change event to initially load data for the default year
                document.getElementById("year-dropdown").dispatchEvent(new Event("change"));
            });
        });
    </script>
</body>

</html>